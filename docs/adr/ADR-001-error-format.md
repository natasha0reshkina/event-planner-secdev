# ADR-001: Единый формат ошибок и идентификатор запроса
Дата: 2025-10-21

## Context
Ответы об ошибках в Event Planner формировались в разрозненных форматах. Это мешало пользователям понимать причину сбоя, а разработчикам — находить соответствующие записи в журнале. Кроме того, в некоторых сообщениях могли случайно попасть технические детали. Необходимо установить единый безопасный формат ошибок.

## Decision
Применяется формат RFC 7807 (Problem Details for HTTP APIs) для всех ошибок, выдаваемых сервером.  
Каждый ответ об ошибке содержит поля:  
`type`, `title`, `status`, `detail`, `correlation_id`.  
Поле `correlation_id` генерируется при каждом запросе и фиксируется в журнале событий, что позволяет связать ошибку с конкретным запросом.  
Личные данные и внутренние ошибки в поле `detail` не выводятся.  

Проверка:
- Все конечные точки возвращают ошибки в формате RFC 7807.  
- Каждое сообщение содержит поле `correlation_id`.  
- Контрактные и сквозные тесты подтверждают наличие и структуру полей.

## Alternatives
1. **Собственный JSON-формат** — требует поддержки и дублирует стандарт.  
2. **Текстовые ошибки без структуры** — проще, но неудобно для клиентов и небезопасно.  
3. **Использование RFC 7807** — стандартный и предсказуемый вариант, поддерживается большинством библиотек.

## Consequences
**Плюсы:**  
- Единообразие ответов.  
- Удобная трассировка по correlation_id.  
- Минимизация утечек технических данных.  

**Минусы:**  
- Требуется обновить слой обработки ошибок и тесты.  
- Небольшое увеличение нагрузки из-за генерации UUID.

## Security impact
Решение снижает риск утечки конфиденциальной информации, так как исключает попадание внутренних сообщений и стек-трейсов в ответы.  
Добавление `correlation_id` повышает прозрачность и облегчает аудит.

## Rollout plan
1. Добавить функцию формирования ошибок в RFC 7807.  
2. Подключить генерацию `correlation_id` для всех запросов.  
3. Обновить все контроллеры на использование этого формата.  
4. Добавить тест `tests/test_errors.py::test_problem_details_contract`.  
5. Проверить формат ответов при ручном тестировании.

## Links
- NFR-02 Формат ошибок и скрытие личных данных  
- F3, R2 из Threat Model  
- tests/test_errors.py::test_problem_details_contract
