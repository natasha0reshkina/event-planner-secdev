# ADR-001: Единый формат ошибок и идентификатор запроса
Дата: 2025-10-21

## Context
Ответы об ошибках в Event Planner формировались в разрозненных форматах. Это мешало пользователям понимать причину сбоя, а разработчикам — находить соответствующие записи в журнале. Кроме того, в некоторых сообщениях могли случайно попасть технические детали. Необходимо установить единый безопасный формат ошибок.

## Decision
Применяется формат RFC 7807 для всех ошибок, выдаваемых сервером.
Каждый ответ об ошибке содержит поля:
type, title, status, detail, correlation_id.
Поле correlation_id генерируется при каждом запросе и фиксируется в журнале событий, что позволяет связать ошибку с конкретным запросом.
Личные данные и внутренние детали в поле detail не выводятся.

Проверка:
все конечные точки возвращают ошибки в формате RFC 7807,
каждое сообщение содержит поле correlation_id,
контрактные и сквозные тесты подтверждают наличие и структуру полей.

## Alternatives
Собственный json формат.
Текстовые ошибки без структуры.
Использование RFC 7807.

## Consequences
Плюсы: единообразие ответов, удобная трассировка по correlation_id, меньше утечек технических деталей.
Минусы: нужно обновить слой обработки ошибок и тесты, небольшая нагрузка на генерацию идентификатора.

## Security impact
Снижается риск утечки конфиденциальной информации, так как исключаются стек трейсы и внутренние детали.
Correlation_id повышает прозрачность и упрощает аудит.

## Rollout plan
Добавить функцию формирования ответов RFC 7807.
Подключить генерацию correlation_id для всех запросов.
Перевести обработчики на единый формат.
Добавить тест tests/test_errors.py::test_problem_details_contract.
Проверить вручную несколько ошибок.

## Links
NFR-02 Формат ошибок и скрытие личных данных
tests/test_errors.py::test_problem_details_contract
