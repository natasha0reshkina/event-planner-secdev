# ADR-002: Валидация даты события
Дата: 2025-10-21

## Context
Пользователи могли создавать события с прошедшими датами. При сравнении даты с текущим моментом возникали ошибки: событие на сегодняшний день считалось прошлым, если создавалось утром. Необходимо нормализовать сравнение и исключить ложные запреты.

## Decision
Дата события сравнивается с началом текущего дня по часовому поясу сервера.  
Если дата меньше начала дня — событие отклоняется, возвращается код 422.  
Дата, равная текущему дню, или будущая дата — принимаются.  
Для проверки используется локальная дата без учёта времени.  

Порог и проверка:
- Не менее 95% корректных отклонений прошлых дат на наборе тестов.  
- Модульные и сквозные тесты на прошлое, настоящее и будущее.  

## Alternatives
1. **Сравнение с текущим моментом (datetime.now)** — может ошибочно отклонять события «сегодня».  
2. **Использование UTC** — требует строгого контроля часовых поясов и синхронизации.  
3. **Сравнение с началом текущего дня** — надёжно для локальных событий и интуитивно понятно пользователю.

## Consequences
**Плюсы:**  
- Предсказуемое поведение.  
- Отсутствие ошибок при создании событий на текущий день.  

**Минусы:**  
- Необходима фиксация часового пояса сервера.  
- Пограничные случаи при переходе суток требуют дополнительных тестов.

## Security impact
Предотвращает ошибки логики, которые могут привести к рассогласованию данных и нарушению целостности расписания.  
Снижает риск некорректного хранения данных о прошедших событиях.

## Rollout plan
1. Добавить проверку даты при создании и обновлении события.  
2. Реализовать возврат кода 422 при ошибке валидации.  
3. Написать тест `tests/test_dates.py::test_rejects_past_date`.  
4. Проверить работу при разных временных зонах.

## Links
- NFR-06 Валидация дат  
- R1 из Threat Model  
- tests/test_dates.py::test_rejects_past_date
